<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Strategy Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            fontFamily: { sans: ['Inter', 'sans-serif'] },
                            colors: {
                                'trading-dark': '#07070a',
                                'trading-card': '#0f0f16',
                                'trading-accent': '#00ff9d', 
                                'trading-danger': '#ff4646',
                                'trading-warn': '#ffcc00',
                                'trading-info': '#3b82f6'
                            }
                        }
                    }
                };
            }
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { background-color: #07070a; color: #ffffff; overflow-x: hidden; }
        .glow-border { border: 1px solid rgba(0, 255, 157, 0.1); transition: all 0.3s ease; }
        .glow-border:hover { border-color: rgba(0, 255, 157, 0.4); box-shadow: 0 0 20px rgba(0, 255, 157, 0.05); }
        .strategy-card { background: #0f0f16; border: 1px solid #1a1a24; }
        .ticker-wrap { width: 100%; overflow: hidden; background: #0f0f16; border-top: 1px solid #1a1a24; padding: 10px 0; position: fixed; bottom: 0; left: 0; z-index: 50; }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 30s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 2rem; font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .btn-glow:hover { box-shadow: 0 0 15px rgba(0, 255, 157, 0.3); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #07070a; }
        ::-webkit-scrollbar-thumb { background: #1a1a24; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 font-sans pb-24 flex items-center justify-center">
    <div class="w-full max-w-7xl mx-auto space-y-6">
        
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 bg-trading-card/50 p-6 md:p-8 rounded-[2rem] border border-white/5 backdrop-blur-md">
            <div class="flex flex-col items-center md:items-start text-center md:text-left">
                <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white uppercase flex items-center gap-2">
                    <span class="bg-trading-accent text-black px-2 py-0.5 rounded italic">FX</span> STRATEGY
                </h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.3em] mt-1">Institutional Intelligence Terminal</p>
            </div>
            
            <div class="flex flex-wrap justify-center items-center gap-4 md:gap-8">
                <div class="text-center md:text-right border-r border-white/10 pr-4 md:pr-8 hidden sm:block">
                    <p class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Market Time (UTC)</p>
                    <p id="live-clock" class="text-xl font-mono font-bold text-white tracking-widest">00:00:00</p>
                </div>
                <div id="session-tag" class="px-5 py-2.5 rounded-2xl bg-trading-accent/10 text-[10px] font-black tracking-widest uppercase text-trading-accent border border-trading-accent/20">
                    STABLE CONNECT
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <div class="lg:col-span-4 space-y-4">
                <div class="strategy-card p-8 rounded-[2.5rem] glow-border shadow-2xl">
                    <div class="flex items-center justify-between mb-10">
                        <span class="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em]">Command Center</span>
                        <span class="w-2 h-2 rounded-full bg-trading-accent animate-pulse"></span>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-3 block ml-1 tracking-widest">Asset Pair</label>
                            <input type="text" id="pair-input" placeholder="e.g. EUR/USD" 
                                   class="w-full bg-trading-dark border border-slate-800 rounded-[1.25rem] p-5 text-white font-black text-lg focus:outline-none focus:border-trading-accent transition-all placeholder:text-slate-800 shadow-inner">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <button class="py-4 bg-slate-900/30 border border-slate-800 rounded-2xl text-[11px] font-black hover:bg-trading-accent hover:text-black transition-all text-white uppercase tracking-tighter" onclick="setPair('EUR/USD')">EURUSD</button>
                            <button class="py-4 bg-slate-900/30 border border-slate-800 rounded-2xl text-[11px] font-black hover:bg-trading-accent hover:text-black transition-all text-white uppercase tracking-tighter" onclick="setPair('GBP/USD')">GBPUSD</button>
                            <button class="py-4 bg-slate-900/30 border border-slate-800 rounded-2xl text-[11px] font-black hover:bg-trading-accent hover:text-black transition-all text-white uppercase tracking-tighter" onclick="setPair('XAU/USD')">GOLD</button>
                            <button class="py-4 bg-slate-900/30 border border-slate-800 rounded-2xl text-[11px] font-black hover:bg-trading-accent hover:text-black transition-all text-white uppercase tracking-tighter" onclick="setPair('USD/JPY')">USDJPY</button>
                        </div>

                        <button id="generate-btn" class="btn-glow w-full bg-trading-accent text-black font-black py-6 rounded-3xl mt-4 hover:scale-[1.01] active:scale-[0.98] transition-all uppercase tracking-tighter text-sm">
                            Run Analysis
                        </button>
                    </div>
                </div>

                <div class="strategy-card p-6 rounded-[2rem] border border-slate-800/50 flex flex-col gap-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest">
                    <div class="flex justify-between items-center">
                        <span>Engine Status</span>
                        <span id="search-status" class="text-trading-accent font-black">Online</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Safety Mode</span>
                        <span class="text-trading-info font-black">Active</span>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div id="report-container" class="strategy-card rounded-[3rem] p-6 md:p-12 min-h-[680px] border border-slate-800/50 relative overflow-hidden flex flex-col items-center justify-center">
                    
                    <div id="loading-state" class="hidden space-y-10 py-20 text-center w-full">
                        <div class="relative flex justify-center">
                            <div class="w-24 h-24 rounded-full border-b-2 border-trading-accent animate-spin"></div>
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-trading-accent font-black text-[10px] tracking-widest">AI</div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-white font-black uppercase tracking-[0.5em] text-xs">Computing Institutional Bias...</p>
                            <p class="text-slate-500 font-bold uppercase tracking-[0.2em] text-[10px]" id="loading-sub">Decoding Volatility Patterns</p>
                        </div>
                    </div>

                    <div id="initial-state" class="flex flex-col items-center justify-center h-full text-center py-10 w-full">
                        <div class="relative mb-14">
                            <div class="absolute inset-0 bg-trading-accent/10 blur-[100px] rounded-full"></div>
                            <div class="relative w-36 h-36 bg-slate-900/30 rounded-full flex items-center justify-center border border-white/5 shadow-2xl backdrop-blur-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-trading-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z" />
                                </svg>
                            </div>
                        </div>
                        <h2 class="text-4xl font-black text-white mb-6 tracking-tighter uppercase italic leading-none">Market <span class="text-trading-accent">Intel</span></h2>
                        <p class="text-slate-500 max-w-sm text-sm font-semibold leading-relaxed mb-12">Institutional-grade analysis for any asset. Using the latest Gemini Flash engine.</p>
                    </div>

                    <div id="report-output" class="hidden w-full space-y-8 h-full"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="ticker-wrap">
        <div class="ticker">
            <div class="ticker-item">SYSTEM STATUS: OPTIMIZED</div>
            <div class="ticker-item text-trading-accent">NO SEARCH MODE: ENABLED</div>
            <div class="ticker-item">COMPATIBILITY: CLOUD STABLE</div>
            <div class="ticker-item text-trading-accent">API HANDLER: V3.0</div>
        </div>
    </div>

    <script>
        // API Configuration
        const apiKey = ""; // Will be provided by the environment
        const modelName = 'gemini-2.5-flash-preview-09-2025';

        function updateClock() {
            const now = new Date();
            const timeStr = now.getUTCHours().toString().padStart(2, '0') + ":" + 
                            now.getUTCMinutes().toString().padStart(2, '0') + ":" + 
                            now.getUTCSeconds().toString().padStart(2, '0');
            const clockEl = document.getElementById('live-clock');
            if (clockEl) clockEl.textContent = timeStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        function setPair(p) { document.getElementById('pair-input').value = p; }

        /**
         * Fetch with Exponential Backoff as per instructions
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let lastError;
            const delays = [1000, 2000, 4000, 8000, 16000];
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    
                    if (response.ok) {
                        return data;
                    } else {
                        // Throw specific error to be caught by the retry loop
                        throw new Error(`API_ERROR: ${response.status} ${data.error?.message || 'Unknown Error'}`);
                    }
                } catch (err) {
                    lastError = err;
                    // Only retry if it's not a 404 or other non-retriable error if desired, 
                    // but mandatory instructions say retry up to 5 times.
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delays[i]));
                    }
                }
            }
            throw lastError;
        }

        async function generateReport() {
            const pair = document.getElementById('pair-input').value.trim().toUpperCase() || "EUR/USD";
            const btn = document.getElementById('generate-btn');
            const loading = document.getElementById('loading-state');
            const initial = document.getElementById('initial-state');
            const output = document.getElementById('report-output');

            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">PROCESSING...</span>`;
            initial.classList.add('hidden');
            output.classList.add('hidden');
            loading.classList.remove('hidden');

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

            try {
                const payload = {
                    contents: [{ 
                        parts: [{ 
                            text: `Act as a senior FX Strategist. Provide an institutional report for ${pair}.
                            Focus on high-conviction technical levels and structural macro trends.
                            
                            Format precisely like this:
                            REPORT_HEADER: ${pair} Analysis | [Score 0-100]
                            SECTION_FACTORS:
                            - [Key driver 1]
                            - [Key driver 2]
                            SECTION_UPCOMING:
                            - [Immediate catalyst]
                            SECTION_LEVELS:
                            - Support: [price]
                            - Resistance: [price]
                            SECTION_CORRELATION:
                            - [Macro context]
                            SECTION_PLAN:
                            - [Strategic advice]
                            METRICS:
                            TREND: [UP/DOWN/SIDEWAYS]
                            CHANCE: [XX%]
                            RISK: [LOW/MEDIUM/HIGH]` 
                        }] 
                    }],
                    systemInstruction: {
                        parts: [{ text: "You are an expert Institutional FX Strategist at a major investment bank. Be concise, data-driven, and authoritative." }]
                    }
                };

                const data = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                if (!text) throw new Error("EMPTY_RESPONSE_FROM_AI");
                
                renderDetailedReport(text);

            } catch (err) {
                console.error("Analysis Failed:", err);
                output.innerHTML = `
                    <div class="p-10 text-center space-y-4">
                        <div class="text-trading-danger font-black text-xl uppercase">Analysis Failed</div>
                        <p class="text-slate-500 text-sm">${err.message}</p>
                        <p class="text-[10px] text-slate-600 uppercase">The engine encountered a processing error. Please check connectivity and try again.</p>
                        <button class="px-6 py-2 bg-white/5 border border-white/10 text-white rounded-xl" onclick="location.reload()">Reset Terminal</button>
                    </div>`;
                output.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
                btn.textContent = "Run Analysis";
            }
        }

        function renderDetailedReport(text) {
            const output = document.getElementById('report-output');
            const getField = (regex, fallback) => {
                const match = text.match(regex);
                return match ? match[1].trim() : fallback;
            };

            const header = getField(/REPORT_HEADER:\s*(.*)/i, "MARKET ANALYSIS");
            const trend = getField(/TREND:\s*(\w+)/i, "NEUTRAL");
            const chance = getField(/CHANCE:\s*(\d+%?)/i, "50%");
            const risk = getField(/RISK:\s*(\w+)/i, "MEDIUM");

            const getSection = (start, end) => {
                const parts = text.split(start);
                if (parts.length < 2) return "Data unavailable.";
                return parts[1].split(end)[0].trim();
            };

            const factorContent = getSection("SECTION_FACTORS:", "SECTION_UPCOMING:");
            const upcomingContent = getSection("SECTION_UPCOMING:", "SECTION_LEVELS:");
            const levelsContent = getSection("SECTION_LEVELS:", "SECTION_CORRELATION:");
            const correlationContent = getSection("SECTION_CORRELATION:", "SECTION_PLAN:");
            const planContent = getSection("SECTION_PLAN:", "METRICS:");

            const formatBullets = (str) => {
                return str.split('\n').filter(l => l.length > 3).map(line => `
                    <div class="flex items-start gap-3 p-3 bg-white/5 rounded-xl border border-white/5 mb-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-trading-accent mt-2 shrink-0"></span>
                        <p class="text-sm text-slate-300 font-medium">${line.replace(/^[-*â€¢\d.]+\s*/, '')}</p>
                    </div>`).join('');
            };

            output.innerHTML = `
                <div class="fade-in space-y-8">
                    <div class="flex justify-between items-end border-b border-white/5 pb-6">
                        <div>
                            <p class="text-[10px] font-black uppercase text-trading-accent tracking-widest mb-1">${trend} TREND</p>
                            <h2 class="text-3xl font-black text-white italic uppercase">${header}</h2>
                        </div>
                        <div class="bg-white/5 px-6 py-3 rounded-2xl border border-white/10">
                            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">PROBABILITY</p>
                            <p class="text-2xl font-black text-white">${chance}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h3 class="text-[10px] font-black uppercase text-slate-500 mb-4 tracking-widest">Market Drivers</h3>${formatBullets(factorContent)}</div>
                        <div><h3 class="text-[10px] font-black uppercase text-trading-accent mb-4 tracking-widest">Catalysts</h3>${formatBullets(upcomingContent)}</div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h3 class="text-[10px] font-black uppercase text-trading-info mb-4 tracking-widest">Price Levels</h3>${formatBullets(levelsContent)}</div>
                        <div><h3 class="text-[10px] font-black uppercase text-trading-warn mb-4 tracking-widest">Macro Outlook</h3>${formatBullets(correlationContent)}</div>
                    </div>

                    <div class="p-6 rounded-3xl bg-trading-accent/10 border border-trading-accent/20">
                        <h4 class="text-[9px] font-black text-trading-accent uppercase tracking-widest mb-2">Strategic Execution</h4>
                        <p class="text-white font-bold">${planContent.split('\n')[0]}</p>
                    </div>
                </div>
            `;
            output.classList.remove('hidden');
        }

        document.getElementById('generate-btn').onclick = generateReport;
    </script>
</body>
</html>
